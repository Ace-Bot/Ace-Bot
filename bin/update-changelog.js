/*
  update-changelog.js by Aceheliflyer
  This script automatically updates `CHANGELOG.md` based on `assets/changelog.json`.
*/
const changelog = require('./../assets/changelog.json')
const { stripIndents, oneLineTrim } = require('common-tags')
const moment = require('moment')
const fs = require('fs')
/**
 * Capitalizes a word.
 * @param {string} char The word you want to capitalize.
 * @return {string} The new capitalized word
 */
var capitalize = char => {
  return char.charAt(0).toUpperCase() + char.slice(1)
}
var repo = 'Aceheliflyer/AceBot'
var text = ''

// Header text.
text += stripIndents`
  # Changelog
  All notable changes to this project will be documented in this file.

  The format is based on [Keep a Changelog](http://keepachangelog.com/en/1.0.0)
  and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.html).

  > Last Updated ${moment(new Date()).format('YYYY/MM/DD HH:mm:SS')}

  ## [Unreleased]
`
text += '\n'

changelog.releases.forEach((release, index, object) => {
  // Changelog header.
  if (index === changelog.releases.length - 1) {
    text += `## ${release.version} - ${release.released}\n`
  } else {
    text += `## [${release.version}] - ${release.released}\n`
  }

  // Changelog footer.
  var types = ['added', 'changed', 'removed', 'fixed']
  types.forEach(type => {
    if (release[type].length > 0) {
      text += `### ${capitalize(type)}\n`
      release[type].sort()
      release[type].forEach(str => {
        text += `- ${str}\n`
      })
      text += '\n'
    }
  })
})

// Write version comparisons.
text += `[Unreleased]: http://github.com/${repo}/compare/v${changelog.releases[0].version}...HEAD\n`
changelog.releases.forEach((release, index, object) => {
  if (index === changelog.releases.length - 1) return
  text += `[${release.version}]: `
  text += oneLineTrim`http://github.com/${repo}/compare/
  v${changelog.releases[index + 1].version}...
  v${release.version}`
  text += '\n'
})
text += '\n'

// Footer text.
text += '---\n\n#### Generated by `bin/update-changelog.js`. ðŸš€'

// eol-last
text += '\n'

// Write to file.
fs.writeFile('./../CHANGELOG.md', text, (error) => {
  if (error) {
    console.error(error)
    process.exit(1)
  }
  process.exit(0)
})
